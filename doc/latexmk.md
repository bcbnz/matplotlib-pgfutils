latexmk integration
===================

[Latexmk][1] is a Perl script for running LaTeX the correct number of times to
build a document. This includes generating bibliographies, indices etc. It can
be extended to include dependencies with custom build commands.

To create a simple rule to automatically build .pypgf figures from .py scripts,
add the following to your `latexmkrc` file:

```perl
# Build PGF images from Python scripts.
add_cus_dep('py', 'pypgf', 0, 'pypgf');
sub pypgf {
    system("python $_[0].py");
}
```

After inputting a figure into your document, i.e., `\input{myfig.pypgf}`,
running latexmk will result in `myfig.py` being run to create the figure. Note
that the first call that latexmk makes to latex will fail due to the missing
figure; either manually exit (in which case latexmk will continue, build the
figure, and rerun latex), or run `latexmk -interaction=nonstopmode` to let it
do this automatically.

Internally, latexmk keeps a database of all generated files and their
dependencies. We can take advantage of pgfutil's ability to [track opened
files](file_tracking.md) to add any source data files to the dependencies, and
any rasterised images to the generated files list. This means that if you
change a data file (e.g., a saved NumPy array), the figure will be
automatically rebuilt. Also, if you ask latexmk to clean the directory, any
rasterised images will be removed. To do this, we need to set the
`PGFUTILS_TRACK_FILES` environment variable to 1 (track files and output a list
to stdout), read the file names and modes into an array, and then add them to
the correct section of the database based on the mode:

```perl
# Build PGF images from Python scripts, and add any dependencies
# and generated images to latexmk's database.
add_cus_dep('py', 'pypgf', 0, 'pypgf');
sub pypgf {
    # Run the script and ask pgfutils to give us a list
    # of all dependencies and extra generated files.
    my @tracked = `PGFUTILS_TRACK_FILES=1 python $_[0].py`;

    # Process the tracked files.
    foreach (@tracked){
        my ($mode, $fn) = /(.):(.+)/;

	# Files opened for reading: dependency.
        if($mode eq "r"){
            rdb_ensure_file($rule, $fn);
        }

	# Opened for writing: generated in addition to the .pypgf file.
	elsif($mode eq "w"){
            rdb_add_generated($fn);
        }
    }
}

# Tell latexmk to remove files generated by custom dependencies when cleaning.
$cleanup_includes_cusdep_generated = 1;
```

In latexmk version 4.61 (and presumably older versions), there is a bug where
the extra generated files are not removed when cleaning. This should be fixed
in subsequent releases. A workaround is to set `$cleanup_includes_generated =
1` instead; however, this also removes **all** generated files (including the
final PDF document) when cleaning so it may not be what you want to do.

See the [file tracking](file_tracking.md) documentation for how the tracking is
implemented and its limitations.

[1]: http://personal.psu.edu/jcc8/software/latexmk/
